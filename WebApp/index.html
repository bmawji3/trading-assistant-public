<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
   <meta content="Responsive Bootstrap Multi-Purpose Crypto Trading User Interface" name="description" />
   <meta name="keywords"
      content="crypto, Bootstrap, bitcoins, ethereum, dogecoin, iota, ripple, siacoin, exchange, trading platform, crypto trading">
   <meta name="author" content="">
   <title>r/wallstreetbets - Trading Assistant</title>
   <link rel="stylesheet" href="app/css/bootstrap.css">
   <link rel="stylesheet" href="plugins/fontawesome/css/font-awesome.css">
   <link rel="stylesheet" href="plugins/animo/animate%2banimo.css">
   <link rel="stylesheet" href="plugins/csspinner/csspinner.min.css">
   <link rel="stylesheet" href="app/css/app.css">
   <script src="plugins/modernizr/modernizr.js"></script>
   <script src="plugins/fastclick/fastclick.js"></script>
</head>

<body>
   <!-- The Modal -->
   <div id="day-modal" class="modal">
      <!-- Modal content -->
      <div class="modal-content">
         <span class="close" id="close-modal">&times;</span>
         <p id="finish-message" style="font-size: 16px;"></p>
      </div>
   </div>

   <section class="wrapperFullWidth">

      <nav class="navbar navbar-default navbar-top navbar-fixed-top">
         <div class="navbar-header">
            <a href="#" class="navbar-brand">
               <div class="brand-logo">r/wallstreetbets TA</div>
            </a>
         </div>
         <div class="nav-wrapper">
            <ul class="nav navbar-nav mt0">
               <h4 id="trading-date" style="margin-left: 16px; margin-top: 15px;">Trading Date: </h4>
               
            </ul>
         </div>
      </nav>
      <section>
         <section class="main-content">
            <button type="button" class="btn btn-labeled btn-primary pull-right" id="finish-button">
               <span class="btn-label">
                  <i class="fa fa-dollar"></i>
               </span>Finish Trading Day
            </button>
            <div class="row">
               <div class="col-md-8">

                  <!-- Chart Starts Here -->
                  <div class="row">
                     <div class="col-lg-12">
                        <div class="panel panel-default">
                           <div class="panel-collapse">
                              <div class="panel-body">
                                 <h4 id="stock-name"></h4>
                                 <div id="candlestickChart" class="h-300">

                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
                  <!-- Chart Ends Here -->
                  <div class="row">
                     <div class="col-md-3">
                        <div data-toggle="play-animation" data-play="fadeInDown" data-offset="0" data-delay="1500" class="panel widget">
                           <div class="panel-body bg-success">
                              <div class="row row-table row-flush">
                                 <div class="col-xs-12">
                                    <p class="mb0"><em class="fa fa-money"></em> Buying Power</p>
                                    <h4 class="m0" id="buying-power">$100,000</h4>
                                    <span class="f-left m-t-10" id="shares-display">
                                    Shares: 0 ($0)
                                    </span>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-9">
                        <div class="panel panel-default">
                           <div class="panel-heading">
                              <h3 class="panel-title">Trading Decision</h3>
                           </div>
                           <div class="panel-body">
                              <div class="col-md-4">
                                 <div class="input-group">
                                    <span class="input-group-addon">$</span>
                                    <input class="form-control" id="buy-input">
                                    <span class="input-group-btn">
                                       <button type="button" class="btn btn-success" id="buy-button">Buy</button>
                                    </span>
                                 </div>
                              </div>
                              <div class="col-md-4">
                                 <div class="input-group">
                                    <span class="input-group-addon">$</span>
                                    <input class="form-control" id="sell-input">
                                    <span class="input-group-btn">
                                       <button type="button" class="btn btn-danger" id="sell-button">Sell</button>
                                    </span>
                                 </div>
                              </div>
                              <div class="col-md-2">
                                 <button type="button" class="btn btn-inverse" id="prev-button">Previous</button>
                              </div>
                              <div class="col-md-1">
                                 <button type="button" class="btn btn-inverse" id="skip-button">Next</button>
                              </div>
                           </div>
                        </div>
                     </div>



                  </div>
               </div>
               <div class="col-md-4">
                  <div class="panel panel-default">
                     <div class="panel-heading">
                        <div class="panel-title">Social Metrics</div>
                     </div>
                     <div class="list-group">                       
                        <div class="list-group-item">
                           <div class="media">
                              <div class="pull-left">
                                 <span class="fa-stack fa-lg">
                                    <em class="fa fa-circle fa-stack-2x text-danger"></em>
                                    <em class="fa fa-level-down fa-stack-1x fa-inverse text-white"></em>
                                 </span>
                              </div>
                              <div class="media-body clearfix">
                                 <strong>Metric 3</strong>
                                 <p class="m0">
                                    <small class="text-danger">$0.02</small>
                                 </p>
                                 <p><i class="fa fa-btc"></i> 0.00000261 <i class="fa fa-level-down text-danger"></i>
                                 </p>
                              </div>
                           </div>
                        </div>
                        
                     </div>
                  </div>
                  <!-- Coin Status Ends Here -->
                  <div class="panel panel-default">
                     <div class="panel-heading">
                        <div class="pull-right"><i class="fa fa-bullhorn"></i></div>
                        <div class="panel-title">Portfolio</div>
                     </div>
                     <table  class="table table-striped table-hover">
                        <thead>
                           <tr>
                              <th>Ticker</th>
                              <th>Price</th>
                              <th>Shares</th>
                              <th>Percent Change</th>
                              <th>Market Value</th>
                           </tr>
                        </thead>
                        <tbody id="portfolio-table"></tbody>
                        <tfoot id="portfolio-foot"> </tfoot>
                     </table>
                  </div>
               </div>
            </div>


         </section>
      </section>
   </section>
   

   <script src="plugins/jquery/jquery.js"></script>
   <script src="plugins/bootstrap/js/bootstrap.js"></script>
   <script src="plugins/chosen/chosen.jquery.js"></script>
   <script src="plugins/velocity/velocity.js"></script>
   <script src="plugins/velocity/velocity.ui.js"></script>
   <script src="plugins/slider/js/bootstrap-slider.js"></script>
   <script src="plugins/filestyle/bootstrap-filestyle.js"></script>
   <script src="plugins/animo/animo.js"></script>
   <script src="plugins/sparklines/jquery.sparkline.js"></script>
   <script src="plugins/slimscroll/jquery.slimscroll.js"></script>
   <script src="plugins/datatable/media/js/jquery.dataTables.js"></script>
   <script src="plugins/datatable/extensions/datatable-bootstrap/js/dataTables.bootstrap.js"></script>
   <script src="plugins/datatable/extensions/datatable-bootstrap/js/dataTables.bootstrapPagination.js"></script>
   <script src="plugins/datatable/extensions/ColVis/js/dataTables.colVis.js"></script>
   <!--<script src="tradify/highcharts.js"></script>-->
   <script src="tradify/exporting.js"></script>
   <script src="plugins/datatable/extensions/ColVis/js/dataTables.colVis.js"></script>

   <script src="https://code.highcharts.com/stock/highstock.js"></script>
   <script src="https://code.highcharts.com/stock/modules/data.js"></script>
   <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
   <script src="https://code.highcharts.com/stock/indicators/indicators.js"></script>
   <script src="https://code.highcharts.com/stock/indicators/bollinger-bands.js"></script>

   <!--[if lt IE 8]><script src="js/excanvas.min.js"></script><![endif]-->
   <script src="app/js/tradify.js"></script>
   <script>
      
      // initialize global variables
      var tradingDays = ["2021-11-12","2021-11-15","2021-11-16","2021-11-17","2021-11-18"]
      var currentDate = 0
      var stockList = []
      var page = 0
      var dataLog = {}

      var buyingPower = 100000
      var portfolio = {}
      var stockData = {} // Hold current stock ohlcv

      function plotStockData(ticker, data){ 
         
         currentPrice = data.Open[Object.keys(data.Date).find(key => data.Date[key] === tradingDays[currentDate])];
         $("#stock-name").html(`${ticker} $${Math.round(currentPrice*100)/100}`);

         // format data
         var ohlc = [], volume = [], dataLength = Object.keys(data.Date).length

         for (i = 0; i < dataLength; i += 1) {
            date = new Date(data.Date[i]).getTime()

            if(date >= new Date(tradingDays[currentDate]).getTime()) continue

            ohlc.push([
                  date, // the date
                  Math.round(data.Open[i] * 100) / 100, // open
                  Math.round(data.High[i] * 100) / 100, // high
                  Math.round(data.Low[i] * 100) / 100, // low
                  Math.round(data.Close[i] * 100) / 100 // close
            ]);

            volume.push([
                  date, // the date
                  data.Volume[i] // the volume
            ]);
         }
         
         // set the allowed units for data grouping
         groupingUnits = [[
            'week',                         // unit name
            [2]                             // allowed multiples
         ], [
            'month',
            [1, 2, 3, 4, 6]
         ]],

         // create the chart
         Highcharts.stockChart('candlestickChart', {

            chart: {
            },
            
            yAxis: [{
               labels: {
                  align: 'right',
                  x: -3
               },
               title: {
                  text: 'OHLC'
               },
               height: '60%',
               lineWidth: 2,
               resize: {
                  enabled: true
               }
            }, {
               labels: {
                  align: 'right',
                  x: -3
               },
               title: {
                  text: 'Volume'
               },
               top: '65%',
               height: '35%',
               offset: 0,
               lineWidth: 2
            }],

            rangeSelector: {
               selected: 0
            },
            series: [{
               type: 'candlestick',
               name: ticker,
               data: ohlc,
               id: ticker,
               dataGrouping: {
                  units: groupingUnits
               }
            }, 
            {
               type: 'bb',
               linkedTo: ticker
            },
            {
               type: 'column',
               name: 'Volume',
               data: volume,
               yAxis: 1,
               dataGrouping: {
                  units: groupingUnits
               }
            }]
         });
      }

      function updatePortfolioDisplay(){
         $("#portfolio-table").html(`
         ${Object.keys(portfolio).map(key => {
            currentPrice = portfolio[key].data.Open[Object.keys(portfolio[key].data.Date).find(k => portfolio[key].data.Date[k] === tradingDays[currentDate])];
            if(currentDate == 0){
               lastPrice = currentPrice
            }else{
               lastPrice = portfolio[key].data.Open[Object.keys(portfolio[key].data.Date).find(k => portfolio[key].data.Date[k] === tradingDays[currentDate-1])];
            } 
            percentChange = Math.round(((currentPrice/lastPrice) - 1)*100 * 100 ) /100

            return(
               `
               <tr>
                  <td>${key}</td>
                  <td>$${Math.round(currentPrice*100)/100}</td>
                  <td>${Math.round(portfolio[key].shares * 100) / 100}</td>
                  <td>${percentChange}% <i class="fa fa-level-${((percentChange > 0) ? 'up' : 'down')}" text-${((percentChange > 0) ? 'success' : 'danger')}"></i></td>
                  <td>\$${(Math.round(portfolio[key].shares * currentPrice * 100) / 100).toLocaleString("en-US")}</td>
               </tr>
               `
            )
         })}
         `)

         portfolioValue = Object.keys(portfolio).map(key => {
            currentPrice = portfolio[key].data.Open[Object.keys(portfolio[key].data.Date).find(k => portfolio[key].data.Date[k] === tradingDays[currentDate])];
            return(portfolio[key].shares * currentPrice)
         }).reduce((pv, cv) => pv + cv, 0);

         $("#portfolio-foot").html(`
               <tr>
                  <th>Buy Power</th>
                  <td></td>
                  <td></td>
                  <td></td>
                  <th>\$${(Math.round(buyingPower * 100) / 100).toLocaleString("en-US")}</th>
               </tr>
               <tr>
                  <th>Total</th>
                  <td></td>
                  <td></td>
                  <td></td>
                  <th>\$${(Math.round((buyingPower + portfolioValue) * 100) / 100).toLocaleString("en-US")}</th>
               </tr>
         `)

         var table = document.getElementById("portfolio-table");
         var rows = table.getElementsByTagName("tr");
         for (i = 0; i < rows.length; i++) {
            var currentRow = table.rows[i];
            var createClickHandler = (row)=> {
               return ()=> {
                  ticker = row.getElementsByTagName("td")[0].innerHTML;
                  getStockData(ticker)
               };
            };
            currentRow.onclick = createClickHandler(currentRow);
         }
            
      }

      function updateBuyingPowerDisplay(){
         currentPrice = portfolio[ticker].data.Open[Object.keys(portfolio[ticker].data.Date).find(key => stockData.Date[key] === tradingDays[currentDate])];

         $("#buying-power").html("$" + buyingPower.toLocaleString("en-US"));
         $("#shares-display").html(`${ticker} Shares: ${Math.round(portfolio[ticker].shares * 100) / 100} (\$${Math.round(portfolio[ticker].shares * currentPrice * 100) / 100})`);
            
      }
   
      function getDailyStocks(date){
         return fetch(`http://127.0.0.1:5000/daily_stocks?date=${date}`)
            .then(response => response.json())
            .then(data=>{ 
               // Get list of stocks that can be traded on the given date
               stocks = data.data.buy_prediction
               data.data.sell_prediction.forEach(s => {
                  if (s in Object.keys(portfolio)){
                     stocks.push(s)
                  }
               });
               return stocks
            })
      }
      
      function getStockData(ticker){
         fetch(`http://127.0.0.1:5000/ticker/${ticker}`)
            .then((response) => response.json())
            .then((data)=>{
               stockData = data.data
               plotStockData(ticker, stockData)
               if(portfolio[ticker]){
                  currentPrice = stockData.Open[Object.keys(stockData.Date).find(key => stockData.Date[key] === tradingDays[currentDate])];
                  $("#shares-display").html(`${ticker} Shares: ${Math.round(portfolio[ticker].shares * 100) / 100} (\$${Math.round(portfolio[ticker].shares * currentPrice * 100) / 100})`);
               }else{
                  $("#shares-display").html(`${ticker} Shares: 0`);
               }
               return fetch(`http://127.0.0.1:5000/indicators/${ticker}?date=${tradingDays[currentDate]}`)
            })
            .then((response) => response.json())
            .then((data) => {
               console.log(data)
            })

      }

   </script>
   
   <script>
      $(document).ready(() => {
         
         $("#trading-date").html(`Trading Date: ${tradingDays[currentDate]}`);
         
         // Get stocks of the day and load chart with the first one
         getDailyStocks(tradingDays[currentDate])
            .then((dailyStocks)=>{
               stockList = dailyStocks
               // Get data from the first stock
               ticker = stockList[0]
               getStockData(ticker)
            })

         // user buttons
         $("#prev-button").click(() => {
            page -= 1
            if (page < 0) page = stockList.length - 1
            ticker = stockList[page]
            getStockData(ticker)
         });
         $("#skip-button").click(() => {
            page += 1
            if (page >= stockList.length) page = 0
            ticker = stockList[page]
            getStockData(ticker)
         });
         $("#buy-button").click(() => {

            // Read input
            buyAmount = $("#buy-input").val()
            if(buyAmount == "" || buyAmount == 0){
               alert("Invalid buy amount")
               return
            }

            // Parse value
            buyAmount = parseFloat(buyAmount.replace(/,/g, ''))
            if(buyAmount > buyingPower){
               alert("Insufficient funds")
               return
            }

            // Get current price and assign amount of stocks to portfolio
            currentPrice = stockData.Open[Object.keys(stockData.Date).find(key => stockData.Date[key] === tradingDays[currentDate])];
            if(portfolio[ticker]) portfolio[ticker].shares += buyAmount/currentPrice
            else portfolio[ticker] = {
               shares: buyAmount/currentPrice,
               data: stockData
            }

            // Reduce buying power
            buyingPower -= buyAmount

            // Update UI
            $("#buy-input").val("0");
            updatePortfolioDisplay()
            updateBuyingPowerDisplay()
         });
         $("#sell-button").click(function() {

            // Read input
            sellAmount = $("#sell-input").val()
            if(sellAmount == "" || sellAmount == 0){
               alert("Invalid sell amount")
               return
            }

            // Get current price and assign amount of stocks to portfolio
            currentPrice = stockData.Open[Object.keys(stockData.Date).find(key => stockData.Date[key] === tradingDays[currentDate])];
            
            // Parse value
            sellAmount = parseFloat(sellAmount.replace(/,/g, ''))
            console.log(ticker)
            if( !portfolio[ticker]  || sellAmount > (portfolio[ticker].shares * currentPrice)){
               alert("Insufficient stocks")
               return
            }

            portfolio[ticker].shares -= sellAmount/currentPrice

            // increase buying power
            buyingPower += sellAmount
            
            $("#sell-input").val("0");
            updatePortfolioDisplay()
            updateBuyingPowerDisplay()
         });

         
         // thousand separators for inputs
         $("#buy-input").on("keyup", function(event ) {                   
            // When user select text in the document, also abort.
            var selection = window.getSelection().toString(); 
            if (selection !== '') {
               return; 
            }       
            // When the arrow keys are pressed, abort.
            if ($.inArray(event.keyCode, [38, 40, 37, 39]) !== -1) {
               return; 
            }       
            var $this = $(this);            
            // Get the value.
            var input = $this.val();            
            input = input.replace(/[\D\s\._\-]+/g, ""); 
            input = input?parseInt(input, 10):0; 
            $this.val(function () {
               return (input === 0)?"":input.toLocaleString("en-US"); 
            }); 
         });
         $("#sell-input").on("keyup", function(event ) {                   
            // When user select text in the document, also abort.
            var selection = window.getSelection().toString(); 
            if (selection !== '') {
               return; 
            }       
            // When the arrow keys are pressed, abort.
            if ($.inArray(event.keyCode, [38, 40, 37, 39]) !== -1) {
               return; 
            }       
            var $this = $(this);            
            // Get the value.
            var input = $this.val();            
            input = input.replace(/[\D\s\._\-]+/g, ""); 
            input = input?parseInt(input, 10):0; 
            $this.val(function () {
               return (input === 0)?"":input.toLocaleString("en-US"); 
            }); 
         });
         

         // When the user clicks the button, open the modal 
         $("#finish-button").click(() =>{
            
            // Show day results modal
            $("#day-modal").css({display: "block"})
            
            // Log user decisions
            portfolioValue = Object.keys(portfolio).map(key => {
               currentPrice = portfolio[key].data.Open[Object.keys(portfolio[key].data.Date).find(k => portfolio[key].data.Date[k] === tradingDays[currentDate])];
               return(portfolio[key].shares * currentPrice)
            }).reduce((pv, cv) => pv + cv, 0);

            dataLog[tradingDays[currentDate]] = {
               buyingPower: buyingPower,
               portfolio: Object.assign({}, Object.keys(portfolio).map((key) => ({[key]: portfolio[key].shares}) )),
               totalMarketValue: portfolioValue + buyingPower
            }

            // Start next date
            currentDate += 1
            

            // finish game and save results in the server
            if(currentDate == tradingDays.length){
               dataLog.total = portfolioValue + buyingPower
               $("#finish-message").html(`GAME OVER`)
               $.ajax({
                  type: "POST",
                  url: `http://127.0.0.1:5000/session_log`,
                  data: JSON.stringify(dataLog),
                  contentType: 'application/json;charset=UTF-8'
               })
               return
            }
            if(currentDate > tradingDays.length) return

            $("#trading-date").html(`Trading Date: ${tradingDays[currentDate]}`);
            updatePortfolioDisplay()

            $("#finish-message").html(`
               Day trading finished for ${tradingDays[currentDate -1]}.<br>
               Now you will start a new day with your current portfolio:
               <br><br>
               New Date: ${tradingDays[currentDate]}

               <table  class="table table-striped table-hover">
                  <thead>
                     <tr>
                        <th>Ticker</th>
                        <th>Price</th>
                        <th>Shares</th>
                        <th>Percent Change</th>
                        <th>Market Value</th>
                     </tr>
                  </thead>
                  <tbody>
                     ${Object.keys(portfolio).map(key => {
                        lastPrice = portfolio[key].data.Open[Object.keys(stockData.Date).find(key => stockData.Date[key] === tradingDays[currentDate-1])];
                        currentPrice = portfolio[key].data.Open[Object.keys(stockData.Date).find(key => stockData.Date[key] === tradingDays[currentDate])];
                        percentChange = Math.round(((currentPrice/lastPrice) - 1)*100 * 100 ) /100
                        return(
                           `
                           <tr>
                              <td>${key}</td>
                              <td>$${Math.round(currentPrice*100)/100}</td>
                              <td>${Math.round(portfolio[key].shares * 100) / 100}</th>
                              <td>${percentChange}% <i class="fa fa-level-${((percentChange > 0) ? 'up' : 'down')}" text-${((percentChange > 0) ? 'success' : 'danger')}"></i></td>
                              <td>\$${(Math.round(portfolio[key].shares * currentPrice * 100) / 100).toLocaleString("en-US")}</th>
                           </tr>
                           `
                        )
                     })}
                  </tbody>
                  <tfoot>
                     <tr>
                        <th>Buying Power</th>
                        <td></td>
                        <td></td>
                        <td></td>
                        <th>\$${(Math.round(buyingPower * 100) / 100).toLocaleString("en-US")}</th>
                     </tr>
                     <tr>
                        <th>Total</th>
                        <td></td>
                        <td></td>
                        <td></td>
                        <th>\$${(Math.round((buyingPower + portfolioValue) * 100) / 100).toLocaleString("en-US")}</th>
                     </tr>
                  </tfoot>
                  
               </table>
               <div style = "height: 50px"></div>
               <button type="button" class="btn btn-labeled btn-success pull-right" id="continue-button">
                  <span class="btn-label">
                     <i class="fa fa-play"></i>
                  </span>Continue
               </button>
               <div style = "height: 20px"></div>
            `)

            // Get stocks of the day and load chart with the first one
            getDailyStocks(tradingDays[currentDate])
            .then((dailyStocks)=>{
               stockList = dailyStocks
               // Get data from the first stock
               ticker = stockList[0]
               getStockData(ticker)
            })

            $("#continue-button").click(function(){
               $("#day-modal").css({display: "none"})
            })

            $("#continue-button").focus()
            
         }) 

         // When the user clicks anywhere outside of the modal, close it
         window.onclick = function(event) {
            if (event.target == document.getElementById("day-modal")) {
               $("#day-modal").css({display: "none"})
            }
         }

         $("#close-modal").click(function(){
            $("#day-modal").css({display: "none"})
         })

         
      });
   </script>
</body>

</html>